--- configure.ac	2011-10-20 04:57:56.000000000 +0300
+++ configure.ac.patch	2011-11-25 10:16:08.000000000 +0300
@@ -209,36 +209,101 @@
 
 AC_MSG_CHECKING([µTP])
 build_utp="no"
-if test "x$HAVE_CXX" = "xyes" ; then
-    have_utp="yes"
-else
-    have_utp="no"
-fi
 AC_ARG_ENABLE([utp],
               AS_HELP_STRING([--enable-utp],[build µTP support]),
               [want_utp=${enableval}],
-              [want_utp=${have_utp}])
+              [want_utp="yes"])
 if test "x$want_utp" = "xyes" ; then
-    if test "x$have_utp" = "xyes"; then 
+    if test "x$HAVE_CXX" = "xyes"; then 
         LIBUTP_CFLAGS="-I\$(top_srcdir)/third-party/"
-        LIBUTP_LIBS="\$(top_builddir)/third-party/libutp/libutp.a"
-        if test "x$libutp_extra_libs" != "x" ; then
-            LIBUTP_LIBS="$LIBUTP_LIBS $libutp_extra_libs"
-        fi
+	LIBUTP_LIBS="\$(top_builddir)/third-party/libutp/libutp.a $libutp_extra_libs"
+	LIBUTP_LIBS_QT="\$\${TRANSMISSION_TOP}/third-party/libutp/libutp.a $libutp_extra_libs"
         AC_DEFINE([WITH_UTP],[1])
         build_utp="yes"
     else 
-      AC_MSG_ERROR("Unable to build uTP support -- C++ compiler not found") 
+	AC_MSG_ERROR("Unable to build uTP support -- C++ compiler not found; consider --disable-utp")
     fi 
 fi 
 AC_SUBST(LIBUTP_CFLAGS)
 AC_SUBST(LIBUTP_LIBS)
+AC_SUBST(LIBUTP_LIBS_QT)
 AM_CONDITIONAL([BUILD_UTP],[test "x$build_utp" = "xyes"])
 AC_MSG_RESULT([$build_utp])
 
 
 dnl ----------------------------------------------------------------------------
 dnl
+dnl  Allow usage of system miniupnp library
+LIBUPNP_CFLAGS="-I\$(top_srcdir)/third-party/"
+LIBUPNP_LIBS="\$(top_builddir)/third-party/miniupnp/libminiupnp.a"
+LIBUPNP_LIBS_QT="\$\${TRANSMISSION_TOP}/third-party/miniupnp/libminiupnp.a"
+build_bundled_miniupnp="yes"
+AC_ARG_ENABLE([external-miniupnp],
+              AS_HELP_STRING([--enable-external-miniupnp],[Use system external-miniupnp]),
+              [want_external_miniupnp=${enableval}],
+              [want_external_miniupnp=no])
+if test "x$want_external_miniupnp" != "xno" ; then
+    AC_DEFINE([SYSTEM_MINIUPNP])
+    ac_save_LIBS="$LIBS"
+    LIBS="-lminiupnpc"
+    # Check miniupnp 1.5
+    AC_TRY_LINK([
+    #include <stdlib.h>
+    #include <miniupnpc/miniupnpc.h>
+    #include <miniupnpc/upnpcommands.h>
+    ],[
+        struct UPNPDev * devlist;
+        struct UPNPUrls    urls;
+        struct IGDdatas    data;
+        char lanaddr[16];
+        char portStr[8];
+        char intPort[8];
+        char intClient[16];
+        upnpDiscover( 2000, NULL, NULL, 0 );
+        UPNP_GetValidIGD( devlist, &urls, &data, lanaddr, sizeof( lanaddr ) );
+        UPNP_GetSpecificPortMappingEntry( urls.controlURL, data.first.servicetype,
+                            portStr, "TCP", intClient, intPort );
+    ],[
+    AC_DEFINE(HAVE_MINIUPNP_15, 1, [Define to 1 if you have miniupnpc version 1.5])
+    build_bundled_miniupnp="no"])
+
+    # Check miniupnp 1.6
+    AC_TRY_LINK([
+    #include <stdlib.h>
+    #include <errno.h>
+    #include <miniupnpc/miniupnpc.h>
+    #include <miniupnpc/upnpcommands.h>
+    ],[
+        struct UPNPDev * devlist;
+        struct UPNPUrls    urls;
+        struct IGDdatas    data;
+        char lanaddr[16];
+        char portStr[8];
+        char intPort[8];
+        char intClient[16];
+        upnpDiscover( 2000, NULL, NULL, 0, 0, &errno );
+        UPNP_GetValidIGD( devlist, &urls, &data, lanaddr, sizeof( lanaddr ) );
+        UPNP_GetSpecificPortMappingEntry( urls.controlURL, data.first.servicetype,
+                            portStr, "TCP", intClient, intPort, NULL, NULL, NULL );
+    ],[
+    AC_DEFINE(HAVE_MINIUPNP_16, 1, [Define to 1 if you have miniupnpc version 1.6])
+    build_bundled_miniupnp="no"])
+
+    if test "x$build_bundled_miniupnp" = "xno" ; then
+        LIBUPNP_CFLAGS=""
+        LIBUPNP_LIBS="-lminiupnpc"
+        LIBUPNP_LIBS_QT="-lminiupnpc"
+    else
+        AC_MSG_ERROR("Requested system libminiupnp but it is not found")
+    fi
+    LIBS="$ac_save_LIBS"
+fi
+AM_CONDITIONAL([BUILD_MINIUPNP],[test "x$build_bundled_miniupnp" = "xyes"])
+AC_SUBST(LIBUPNP_CFLAGS)
+AC_SUBST(LIBUPNP_LIBS)
+AC_SUBST(LIBUPNP_LIBS_QT)
+dnl ----------------------------------------------------------------------------
+dnl
 dnl  detection for the GTK+ client
 
 
@@ -431,6 +496,7 @@
                  web/javascript/Makefile
                  web/javascript/jquery/Makefile
                  web/stylesheets/Makefile
+		 qt/config
                  po/Makefile.in])
 
 AC_OUTPUT
